- name: Opennet-CA-Zertifikate uebertragen
  # Diese Kombination von archive und checksum verhindert Dateiuebertragungen wegen
  # verschiedener Zeitstempel (z.B. basierend auf dem lokalen git-checkout).
  synchronize:
    delete=yes
    archive=no
    checksum=yes
    recursive=yes
    src=opennet-ca/
    dest=/usr/local/share/ca-certificates/opennet-initiative.de/
  register: updated_ca_certificates

# wir muessen die neuen CA-Zertifikate sofort aktivieren, damit der folgende Download funktioniert
- name: CA-Zertifikate aktivieren
  command: update-ca-certificates
  when: updated_ca_certificates.changed

- name: Verzeichnis /usr/local/sbin erzeugen
  file: state=directory
        recurse=true
        path=/usr/local/sbin

- name: Skript 'opennetca_crldownload' herunterladen
  get_url:
    dest=/usr/local/sbin/opennetca_crldownload.sh
    mode=755
    owner=root
    url="https://dev.opennet-initiative.de/browser/on_opennetca/opennetca_crldownload.sh?format=raw"

- name: CRL-Verzeichnis erstellen
  file:
    path=/etc/ssl/crl
    state=directory

- name: Cron-Jobs fuer die Aktualisierung der CA-Widerrufslisten eintragen
  cron:
    state=present
    name="Zerifikatswiderrufslisten fuer {{ item.name }} regelmaessig aktualisieren"
    hour="1,13"
    minute="{{ item.minute }}"
    job="/usr/local/sbin/opennetca_crldownload.sh {{ item.crl }} /etc/ssl/crl {{ item.ca_cert }} >/dev/null"
  with_items: opennet_ca_crl_list

- name: CA-Widerrufslisten erstmals herunterladen, falls nicht vorhanden
  command:
    creates=/etc/ssl/crl/{{ item.crl }}
    /usr/local/sbin/opennetca_crldownload.sh {{ item.crl }} /etc/ssl/crl {{ item.ca_cert }}
  with_items: opennet_ca_crl_list
