#!/bin/sh

. "$MUNIN_LIBDIR/plugins/plugin.sh"


set -eu


UNKNOWN_VERSION="unknown"


# prepend numeric versions with a "v" (otherwise the first character is lost)
get_version_fieldname() {
	local version="$1"
	if echo "$version" | grep -q "^[0-9]"; then
		clean_fieldname "v$version"
	else
		clean_fieldname "$version"
	fi
}

get_version_counts() {
	# numeric sorting of versions
	# The "000000" substitution helps to sort "unstable" before the following regular release.
	curl -s https://api.on-i.de/api/v1/accesspoint/ \
		| jq -r '.[].opennet_version' \
		| sed 's/^null$//' \
		| sed 's/unstable-.*$/000000/' \
		| sed 's/^$/unknown/' \
		| sort -V \
		| sed 's/000000/unstable/' \
		| uniq -c
}


if [ "${1:-}" = "config" ]; then
	echo "graph_title Firmware-Versionen auf APs"
	echo "graph_category opennet"
	echo "graph_vlabel Anzahl der APs"

	get_version_counts | while read -r count version; do
		fieldname=$(get_version_fieldname "$version")
                if [ "$version" = "$UNKNOWN_VERSION" ]; then
			echo "$fieldname.label unbekannt (keine ondataservice-Daten)"
		else
			echo "$fieldname.label $version"
                fi
		echo "$fieldname.draw AREASTACK"
	done
	if [ "${MUNIN_CAP_DIRTYCONFIG:-0}" != 1 ]; then exit 0; fi
fi


get_version_counts | while read -r count version; do
	fieldname=$(get_version_fieldname "$version")
	echo "$fieldname.value $count"
done
