- name: openvpn und Abhaengigkeiten installieren
  apt: pkg={{ item }} state=present
  with_items:
    - openvpn
    # Python-Skripte werden fuer Portweiterleitungen und Adressvergabe verwendet
    - python
    - python-ipaddr
    # die Portweiterleitungen werden via sudo angelegt
    - sudo

- name: VPN-Gruppe anlegen
  user: state=present
        name=openvpn
        system=yes

- name: VPN-Nutzer anlegen
  user: state=present
        name=openvpn
        createhome=no
        group=openvpn
        system=yes

- name: Log-Verzeichnis anlegen
  file: state=directory
        dest=/var/log/openvpn
        owner=openvpn
        group=openvpn 
        mode=700

- name: Diffie-Hellmann initialisieren
  command: creates=/etc/openvpn/dh2048.pem openssl dhparam -out /etc/openvpn/dh2048.pem 2048

# Unterverzeichnisse erzeugen
- name: VPN-Verzeichnisse erzeugen
  file: dest=/etc/openvpn/{{ item }} state=directory
  with_items:
    - opennet_users
    - opennet_ugw

- name: Nutzer-VPN-Skripte uebertragen
  copy: force=yes
        src=openvpn/opennet_users/{{ item }}
        dest=/etc/openvpn/opennet_users/{{ item }}
        mode=755
  with_items:
    - connection_script.py
    - connectcalc.py
    - output_cert_ca.sh
    - test-connect_script.py
    - tls_verify.sh

- name: UGW-VPN-Skripte uebertragen
  copy: force=yes
        src=openvpn/opennet_ugw/{{ item }}
        dest=/etc/openvpn/opennet_ugw/{{ item }}
        mode=755
  with_items:
    - connect_script.py
    - test-connect_script.py

- name: CA-Zertifikat uebertragen
  copy: force=yes
        src=openvpn/{{ item }}/ca.crt
        dest=/etc/openvpn/{{ item }}/
  with_items:
    - opennet_users
    - opennet_ugw

# Zertifikate und Schluessel pruefen (Nutzer-VPN)
# Diese Dateien muessen manuell uebertragen werden.
- name: Vorhandensein von lokalem Nutzer-VPN-Zertifikat pruefen
  stat: path={{ openvpn_users_cert_file }}
  register: openvpn_users_certificate

- fail: msg="OpenVPN-Zertifikat fuer Nutzer-VPN fehlt ({{ openvpn_users_cert_file }})"
  when: not openvpn_users_certificate.stat.exists

- name: Vorhandensein von lokalem Nutzer-VPN-Schluessel pruefen
  stat: path={{ openvpn_users_key_file }}
  register: openvpn_users_key

- fail: msg="OpenVPN-Schluessel fuer Nutzer-VPN fehlt ({{ openvpn_users_key_file }})"
  when: not openvpn_users_key.stat.exists

# Zertifikate und Schluessel pruefen (UGW-VPN)
# Diese Dateien muessen manuell uebertragen werden.
- name: Vorhandensein von lokalem UGW-VPN-Zertifikat pruefen
  stat: path={{ openvpn_ugw_cert_file }}
  register: openvpn_ugw_certificate

- fail: msg="OpenVPN-Zertifikat fuer UGW-VPN fehlt ({{ openvpn_ugw_cert_file }})"
  when: not openvpn_ugw_certificate.stat.exists

- name: Vorhandensein von lokalem UGW-VPN-Schluessel pruefen
  stat: path={{ openvpn_ugw_key_file }}
  register: openvpn_ugw_key

- fail: msg="OpenVPN-Schluessel fuer UGW-VPN fehlt ({{ openvpn_ugw_key_file }})"
  when: not openvpn_ugw_key.stat.exists

- name: Nutzer-VPN-Konfiguration uebertragen
  template: src=opennet_users.conf
            dest=/etc/openvpn/
  notify: restart openvpn

- name: UGW-VPN-Konfiguration uebertragen
  template: src=opennet_ugw.conf
            dest=/etc/openvpn/
  notify: restart openvpn

- name: Port-Weiterleitungen als Nutzer 'openvpn' via sudo erlauben
  copy: force=yes
        content="openvpn ALL=(root) NOPASSWD:/sbin/iptables\n"
        dest=/etc/sudoers.d/opennet-openvpn

